package main

import (
	"bytes"
	"os"
	"path/filepath"
	"strings"

	"github.com/ranger/ranger/tests/framework/codegen/generator"
	managementSchema "github.com/ranger/ranger/tests/framework/pkg/schemas/management.cattle.io/v3"
)

func main() {
	os.Unsetenv("GOPATH")
	generator.GenerateClient(managementSchema.Schemas, map[string]bool{
		"userAttribute": true,
	})

	if err := replaceClientBasePackages(); err != nil {
		panic(err)
	}
}

// replaceClientBasePackages walks through the zz_generated_client generated by generator.GenerateClient to replace imports from
// "github.com/ranger/norman/clientbase" to "github.com/ranger/ranger/tests/framework/pkg/clientbase" to use our modified code of the
// session.Session tracking the resources created by the Management Client.
func replaceClientBasePackages() error {
	return filepath.Walk("./clients/ranger/generated", func(path string, info os.FileInfo, err error) error {
		if err != nil {
			return err
		}

		if strings.HasPrefix(info.Name(), "zz_generated_client") {
			input, err := os.ReadFile(path)
			if err != nil {
				return err
			}

			replacement := bytes.Replace(input, []byte("github.com/ranger/norman/clientbase"), []byte("github.com/ranger/ranger/tests/framework/pkg/clientbase"), -1)

			if err = os.WriteFile(path, replacement, 0666); err != nil {
				return err
			}
		}

		return nil
	})
}
